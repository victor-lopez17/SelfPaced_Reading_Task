<!--  Title: Self-Paced Reading Task
      Date: 06/02/2025
      Author: Víctor López Domínguez
      Repository link: https://github.com/Vieju17/TFG_ExperimentDesign.git
-->

<!-- Metadata -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reading Task</title>

    <!-- Page Icon -->
    <link rel="icon" href="./common/img/uabLogo.png" />

    <!-- Plugins -->
    <script src="./common/jspsych/dist/jspsych.js"></script>
    <script src="./common/jspsych/dist/plugin-html-keyboard-response.js"></script>
    <script src="./common/jspsych/dist/plugin-survey-html-form.js"></script>
    <script src="./common/jspsych/dist/plugin-survey.js"></script>
    <script src="./common/jspsych/dist/plugin-html-button-response.js"></script>
    <script src="./common/jspsych/dist/plugin-fullscreen.js"></script>
    <script src="./common/items.js"></script>

    <!-- Stylesheet -->
    <link rel="stylesheet" href="./common/style.css" />
  </head>

  <!-- Aesthetics -->
  <body>
    <div class="banner">
      <div class="container" id="banner-container">
        <div id="banner-stripe1"></div>
        <div id="banner-stripe2"></div>
      </div>
      <div class="container" id="banner-logo-container">
        <img src="./common/img/uabLogo.png" id="uabLogo" alt="uab logo" />
        <img src="./common/img/grelaLogo.png" id="grelaLogo" alt="grela logo" />
      </div>
    </div>
  </body>

  <!-- Experiment Script -->
  <script>
    // Initializing jsPsych and Experiment Timeline
    const jsPsych = initJsPsych({
      on_finish: function () {
        var part_id = `${jsPsych.data.get().values()[0].part_id}.csv`;

        jsPsych.data.get().localSave("csv", part_id);
      },
    });

    var timeline = [];

    timeline.push({
      type: jsPsychFullscreen,
      message: `<div class='container'>
        <p>The experiment will switch to <b>full screen mode</b> when you press the button below.</p>
      </div>`, 
      fullscreen_mode: true
    })

    // Introduction
    var intro = {
      type: jsPsychSurveyHtmlForm,
      simulation_options: {
        simulate: false,
      },
      html: `<div class='container'>
        <h1>Welcome!</h1>
        <p>You are about to participate in a <br>
        <b>self-paced reading task</b>.</p>
        <p>Please, enter your participant ID below:</p>
        <input name="part_id" type="number" required placeholder="Part. ID"></input>
      </div>`,
      button_label: "Instructions",
      on_finish: function (data) {
        jsPsych.data.addProperties({
          part_id: data.response.part_id,
        });
      },
    };
    timeline.push(intro);

    // Instructions
    var inst = {
      type: jsPsychHtmlButtonResponse,
      simulation_options: {
        simulate: false,
      },
      stimulus: `<div class='container'>
        <h1>Instructions</h1>
        <p>For this task, you will be presented with sentences divided into segments. However, these segments will be initially hidden.</p>

        <p>In order to complete the task, you are asked to <b>press the space bar</b> each time you are done reading each segment. This will reveal the following segment and hide the previous one. Watch the video below for clarification.</p>

        <div class="instructions-video-container">
          <video src="./common/img/keyboard_animation.mp4" type="video/mp4" autoplay loop muted preload="auto"></video>
        </div>

        <p>By the end of some of the sentences, you will be asked to <b>answer a question</b> on the sentence you just read by pressing either <b>F</b> or <b>J</b>. So, make sure to <b>take the time</b> to understand what you read!</p>

        <p>Once you have finished reading a sentence and you have answered its question, if any, the next one will appear. This will repeat until the test is done.</p>


        <svg class="instructions-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path id="instructions-arrow1" d="m7 6 5 5 5-5"/><path id="instructions-arrow2" d="m7 13 5 5 5-5"/></svg>

      <div>`,
      choices: ["Practice"],
      button_html: (choice) => `<div class='button'>${choice}
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10"/><path d="m10 8 4 4-4 4"/></svg>
        </div>`,
      record_data: false,
      post_trial_gap: 1000,
    };
    timeline.push(inst);

    // Trial
    var trial = [
      {
        type: jsPsychHtmlKeyboardResponse,
        choices: [" "],
        stimulus: jsPsych.timelineVariable("s0"),
        simulation_options: "short_response",
        data: {
          task: "item",
          item_number: jsPsych.timelineVariable("item_number"), 
          item_type: jsPsych.timelineVariable("item_type"),
          segment: "s0",
          clause_type: jsPsych.timelineVariable("clause_type"),
          number: jsPsych.timelineVariable("number"),
        },
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        choices: [" "],
        stimulus: jsPsych.timelineVariable("s1"),
        simulation_options: "short_response",
        data: {
          task: "item",
          item_number: jsPsych.timelineVariable("item_number"), 
          item_type: jsPsych.timelineVariable("item_type"),
          segment: "s1",
          clause_type: jsPsych.timelineVariable("clause_type"),
          number: jsPsych.timelineVariable("number"),
        },
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        choices: [" "],
        stimulus: jsPsych.timelineVariable("s2"),
        simulation_options: "short_response",
        data: {
          task: "item",
          item_number: jsPsych.timelineVariable("item_number"), 
          item_type: jsPsych.timelineVariable("item_type"),
          segment: "s2",
          clause_type: jsPsych.timelineVariable("clause_type"),
          number: jsPsych.timelineVariable("number"),
        },
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        choices: [" "],
        stimulus: jsPsych.timelineVariable("s3"),
        simulation_options: "short_response",
        data: {
          task: "item",
          item_number: jsPsych.timelineVariable("item_number"), 
          item_type: jsPsych.timelineVariable("item_type"),
          segment: "s3",
          clause_type: jsPsych.timelineVariable("clause_type"),
          number: jsPsych.timelineVariable("number"),
        },
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        choices: [" "],
        stimulus: jsPsych.timelineVariable("s4"),
        simulation_options: "long_response",
        data: {
          task: "item",
          item_number: jsPsych.timelineVariable("item_number"), 
          item_type: jsPsych.timelineVariable("item_type"),
          segment: "s4",
          clause_type: jsPsych.timelineVariable("clause_type"),
          number: jsPsych.timelineVariable("number"),
        },
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        choices: [" "],
        stimulus: jsPsych.timelineVariable("s5"),
        simulation_options: "long_response",
        data: {
          task: "item",
          item_number: jsPsych.timelineVariable("item_number"), 
          item_type: jsPsych.timelineVariable("item_type"),
          segment: "s5",
          clause_type: jsPsych.timelineVariable("clause_type"),
          number: jsPsych.timelineVariable("number"),
          question: jsPsych.timelineVariable("question"),
        },
        post_trial_gap: 500,
      },
    ];
    
    // Trial Question
    var trial_question = {
      type: jsPsychHtmlKeyboardResponse,
      simulation_options: "question_response",
      choices: ["f", "j"],
      stimulus: jsPsych.timelineVariable("question"),
      data: {
        task: "question",
        item_number: jsPsych.timelineVariable("item_number"), 
        item_type: jsPsych.timelineVariable("item_type"),
        correct_answer: jsPsych.timelineVariable("correct_answer"),
        clause_type: jsPsych.timelineVariable("clause_type"),
        number: jsPsych.timelineVariable("number"),
      },
      on_finish: function (data) {
        jsPsych.data.addDataToLastTrial({
          part_answer: data.response,
        });

        return (data.response.toLowerCase() === data.correct_answer.toLowerCase()) ? data.correct = 1 : data.correct = 0;
      },
      post_trial_gap: 500,
    };

    // Trial Question Node
    var condition = function () {
      // Get the last trial data
      var lastTrialData = jsPsych.data.get().last(1).values()[0];
      // Show question for experimental and filler items
      return lastTrialData.question !== false;
    };

    var trial_question_node = {
      timeline: [trial_question],
      conditional_function: condition,
    };

    // Practice Procedure
    var pr_procedure = {
      timeline: [trial, trial_question_node],
      timeline_variables: [
        {
          s0: '<p class="trial-stimulus">_______ | ____ | _______ | _______ | ____</p>',
          s1: '<p class="trial-stimulus">The cat | ____ | _______ | _______ | ____</p>',
          s2: '<p class="trial-stimulus">_______ | that | _______ | _______ | ____</p>',
          s3: '<p class="trial-stimulus">_______ | ____ | watches | _______ | ____</p>',
          s4: '<p class="trial-stimulus">_______ | ____ | _______ | the dog | ____</p>',
          s5: '<p class="trial-stimulus">_______ | ____ | _______ | _______ | eats</p>',
          item_type: "pr_item",
          clause_type: "sr",
          number: "ss",
          question: false,
          correct_answer: 0,
          item_number: null,
        },
        {
          s0: '<p class="trial-stimulus">_________ | ____ | _________ | _____ | ______</p>',
          s1: '<p class="trial-stimulus">The horse | ____ | _________ | _____ | ______</p>',
          s2: '<p class="trial-stimulus">_________ | that | _________ | _____ | ______</p>',
          s3: '<p class="trial-stimulus">_________ | ____ | the zebra | _____ | ______</p>',
          s4: '<p class="trial-stimulus">_________ | ____ | _________ | kicks | ______</p>',
          s5: '<p class="trial-stimulus">_________ | ____ | _________ | _____ | laughs</p>',
          item_type: "pr_item",
          clause_type: "or",
          number: "ss",
          question: `<div class='container trial-question'>
            <h2 class='trial-question-header'>Who laughs?</h2>
            <div>
              <div class='container'>
                <h2 class='trial-question-answer'>The zebra</h2>
                <h2 class='trial-question-key'>F</h2>
              </div>
              <div class='container'>
                <h2 class='trial-question-answer'>The horse</h2>
                <h2 class='trial-question-key'>J</h2>
              </div>
            </div>
          </div>`,
          correct_answer: "j",
          item_number: null,
        },
      ],
      repetitions: 1,
    };
    timeline.push(pr_procedure);

    // Test Beginning
    var start_prompt = {
      type: jsPsychHtmlButtonResponse,
      simulation_options: {
        simulate: false,
      },
      stimulus: `<div class='container'>
        <h1>Practice is Over!</h1>
        <p>Now, you will start the test. Remember to <b>take your time to read and understand</b> each sentence.</p>
        <p>Press the button below to begin.</p>
      </div>`,
      choices: ["Begin"],
      button_html: (choice) => `<div class='button'>${choice}
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10"/><path d="m10 8 4 4-4 4"/></svg>
        </div>`,
      record_data: false,
      on_finish: function () {
        var element1 = document.getElementById("banner-stripe1");
        var element2 = document.getElementById("banner-stripe2");
        var element3 = document.getElementById("uabLogo");
        var element4 = document.getElementById("grelaLogo");

        element1.classList.toggle("animate-banner-out");
        element2.classList.toggle("animate-banner-out");
        element3.classList.toggle("animate-logo2-out");
        element4.classList.toggle("animate-logo1-out");
      },
      post_trial_gap: 2000,
      record_data: false,
    };
    timeline.push(start_prompt);

    // Trial Procedure
    var trial_procedure = {
      timeline: [trial, trial_question_node],
      timeline_variables: stimulus,
      randomize_order: true,
      sample: {
        type: "without-replacement",
        //size: 2, // For testing purposes
        size: stimulus.length, // 32 items + 15 fillers
      },
    };
    timeline.push(trial_procedure);

    // Experiment Ending
    var debrief = {
      type: jsPsychHtmlKeyboardResponse,
      simulation_options: {
        simulate: false,
      },
      stimulus: function () {
        var s1_mean = Math.round(
          jsPsych.data.get().filter({ segment: "s1" }).select("rt").mean()
        );
        var s2_mean = Math.round(
          jsPsych.data.get().filter({ segment: "s2" }).select("rt").mean()
        );
        var s3_mean = Math.round(
          jsPsych.data.get().filter({ segment: "s3" }).select("rt").mean()
        );
        var s4_mean = Math.round(
          jsPsych.data.get().filter({ segment: "s4" }).select("rt").mean()
        );
        var s5_mean = Math.round(
          jsPsych.data.get().filter({ segment: "s5" }).select("rt").mean()
        );

        var trials = jsPsych.data.get().filter({ task: "question" });
        var correct_trials = trials.filter({ correct: 1 });

        var accuracy = Math.round(
          (correct_trials.count() / trials.count()) * 100
        );

        return `<div class='container'>
          <h1>Well Done!</h1>
          <p>
           The test has come to an end.<br>
           Here are the means of your <b>reaction times</b> for each segment and your overall <b>accuracy score</b>:
          </p>
          <div id = "results">
            <p>
              <b>Segment 1:</b> ${s1_mean}ms<br>
              <b>Segment 2:</b> ${s2_mean}ms<br>
              <b>Segment 3:</b> ${s3_mean}ms<br>
              <b>Segment 4:</b> ${s4_mean}ms<br>
              <b>Segment 5:</b> ${s5_mean}ms
            </p>
            <div class = "container" id = "accuracy">
              <p>
                <b>Score:</b>
              </p>
              <p id = "percentage">
                ${accuracy}%
              </p>
            </div>
          </div>
          <h2>Thank you for your time!</h2>
        </div>`;
      },
      choices: ["o"],
      on_start: function () {
        var element1 = document.getElementById("banner-stripe1");
        var element2 = document.getElementById("banner-stripe2");
        var element3 = document.getElementById("uabLogo");
        var element4 = document.getElementById("grelaLogo");

        element1.classList.toggle("animate-banner-in");
        element2.classList.toggle("animate-banner-in");
        element3.classList.toggle("animate-logo2-in");
        element4.classList.toggle("animate-logo1-in");
      },
      record_data: false,
    };
    timeline.push(debrief);

    // Simulation
    const simulation_options = {
      question_response: {
        data: {
          rt: 5000
        },
      },
      long_response: {
        data: {
          rt: () => {
            return jsPsych.randomization.sampleWithReplacement(
              [750, 1000, 1250, 1500, 2000],
              1
            );
          },
        },
      },
      short_response: {
        data: {
          rt: () => {
            return jsPsych.randomization.sampleWithReplacement(
              [250, 375, 500, 750, 1000],
              1
            );
          },
        },
      },
    };

    jsPsych.run(timeline);
    //jsPsych.simulate(timeline, "data-only", simulation_options);
  </script>
</html>

